<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyBuddy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        * { box-sizing: border-box; } /* More predictable box model */
        /* General Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f9ff; /* Tailwind sky-50 */
            overscroll-behavior-y: contain; 
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
        }
        .card {
            background-color: white;
            border-radius: 0.75rem; 
            padding: 1.5rem; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; 
            font-weight: 600; 
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: 1px solid transparent;
            user-select: none; /* Prevent text selection on buttons */
        }
        .btn:active { /* Subtle feedback on tap */
            transform: scale(0.98);
        }
        .btn-primary { background-color: #0d9488; color: white; }
        .btn-primary:hover { background-color: #0f766e; box-shadow: 0 2px 10px -1px rgba(13, 148, 136, 0.5); }
        .btn-secondary { background-color: #475569; color: white; }
        .btn-secondary:hover { background-color: #334155; }
        .btn-outline { border-color: #0d9488; color: #0d9488; }
        .btn-outline:hover { background-color: #ccfbf1; color: #0f766e; }
        .btn-warning { background-color: #f59e0b; color: white; }
        .btn-warning:hover { background-color: #d97706; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-danger:hover { background-color: #b91c1c; }

        /* --- New Google Login Button Style --- */
        .btn-google {
            background-color: #ffffff;
            color: #374151; /* gray-700 */
            border: 1px solid #d1d5db; /* gray-300 */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem; /* space between icon and text */
        }
        .btn-google:hover {
            background-color: #f9fafb; /* gray-50 */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        .google-icon {
            width: 1.25rem;
            height: 1.25rem;
        }

        /* Game Specific Styles */
        .game-card {
            min-height: 150px; display: flex; align-items: center; justify-content: center;
            text-align: center; cursor: pointer; border: 1px solid #99f6e4; 
            overflow-wrap: break-word; word-break: break-word;
        }
        .selected-match { border: 2px solid #0d9488; background-color: #f0fdfa; }
        .matched { opacity: 0.4; pointer-events: none; background-color: #a7f3d0; border-color: #34d399; }
        .incorrect-match-animation { animation: shake 0.4s; border: 2px solid #ef4444 !important; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-6px); } 75% { transform: translateX(6px); } }

        .mcq-option-btn, .part-selection-btn, .essentials-category-btn, .essentials-action-btn {
            display: block; width: 100%; text-align: left; margin-bottom: 0.5rem;
            background-color: #f8fafc; border: 1px solid #cbd5e1; color: #334155;
            white-space: normal; overflow: hidden; text-overflow: ellipsis; padding: 0.75rem 1rem;
        }
        .mcq-option-btn:hover, .part-selection-btn:hover, .essentials-category-btn:hover, .essentials-action-btn:hover {
            background-color: #f1f5f9; border-color: #94a3b8;
        }
        #mcqQuestion.speakable-question:hover { cursor: pointer; background-color: #e0f2f7; }
        .correct-answer { background-color: #d1fae5 !important; border-color: #6ee7b7 !important; color: #065f46 !important; }
        .incorrect-answer { background-color: #fee2e2 !important; border-color: #fca5a5 !important; color: #991b1b !important; }
        .stack-selection-btn { background-color: #eef2ff; color: #4338ca; border: 1px solid #c7d2fe; }
        .stack-selection-btn:hover { background-color: #e0e7ff; }

        /* UI Elements */
        #musicToggleBtn { position: fixed; top: 1rem; right: 1rem; z-index: 1000; background-color: rgba(255,255,255,0.7); backdrop-filter: blur(4px); border: 1px solid #99f6e4; color: #0d9488; }
        .capybara-life-icon { width: 2rem; height: 2rem; color: #8d5524; transition: opacity 0.3s ease, transform 0.3s ease; vertical-align: middle; }
        .capybara-life-icon.mistake { opacity: 0.3; transform: scale(0.75) rotate(-8deg) translateX(2px); color: #a1a1aa; }
        #gameInfoBar {
            display: flex;
            justify-content: space-between;
            align-items: center; /* Center items vertically */
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background-color: #f8fafc;
            border-radius: 0.375rem;
            flex-wrap: wrap; 
            gap: 0.5rem; 
        }
        #mistakeTracker { display: flex; gap: 0.5rem; flex-shrink: 0; }
        #scoreDisplayContainer { display: flex; flex-direction: column; align-items: flex-end; flex-shrink: 0; margin-left: auto; /* Push to right if space allows */ }
        #currentScoreDisplay { font-size: 1.125rem; font-weight: 600; color: #0d9488; }
        #maxScoreDisplay { font-size: 0.875rem; color: #0f766e;}
        .truncate-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; max-width: 100%; }
        #roundCompleteMessage, #bonusRoundCountdownMessage { text-align: center; font-size: 1.5rem; font-weight: 600; color: #0d9488; padding: 2rem; border: 2px dashed #99f6e4; border-radius: 0.5rem; margin-top: 1rem; }

        #talkToMePhraseToRead { min-height: 80px; padding-bottom: 2.5rem; position: relative; }
        #talkToMeRecognizedText, #talkToMeReferenceDisplay { min-height: 40px; }
        #speakPhraseBtn { position: absolute; bottom: 0.5rem; left: 50%; transform: translateX(-50%); padding: 0.3rem; background-color: rgba(255,255,255,0.5); }
        #speakPhraseBtn svg { width: 1.25rem; height: 1.25rem; color: #0d9488; }
        #listenBtn.listening { background-color: #ef4444; color: white; }
        #listenBtn.listening:hover { background-color: #dc2626; }

        .header-logo-image { max-width: 120px; height: auto; margin: 0 auto; }
        #hearItOutLoudToggleBtn.active { background-color: #0d9488; color: white; }

        .selected-find-word { background-color: #cffafe !important; border-color: #67e8f9 !important; outline: 2px solid #06b6d4; }

        #fillInTheBlanksSentence.speakable-question:hover { cursor: pointer; background-color: #e0f2f7; }
        .blank-input { border-bottom: 2px solid #0d9488; padding: 0.25rem 0.5rem; margin: 0 0.25rem; background-color: transparent; text-align: center; min-width: 80px; }
        #fillInTheBlanksSentence .blank-placeholder { display: inline-block; width: 100px; border-bottom: 1px solid #334155; text-align: center; font-style: italic; color: #64748b; }

        #targetLanguageSelectorContainer { margin-bottom: 1rem; }
        #targetLanguageSelector, #languageSelectorInGame { 
            padding: 0.5rem; font-size: 0.875rem; border: 1px solid #cbd5e1;
            border-radius: 0.375rem; width: auto; 
        }
        #targetLanguageSelector:focus, #languageSelectorInGame:focus {
            outline: 2px solid transparent; outline-offset: 2px;
            border-color: #0d9488; box-shadow: 0 0 0 2px #0d9488;
        }
        #languageSelectionInGameContainer {
            display: flex; align-items: center; 
            flex-grow: 1; /* Allow it to take available space */
            flex-shrink: 1; /* Allow it to shrink */
            min-width: 130px; /* Give it a minimum width to prevent excessive squishing */
            margin-right: 0.5rem; /* Space before next item if wrapped */
        }
        #languageSelectionInGameContainer label {
            margin-right: 0.5rem; font-size: 0.875rem; color: #334155; white-space: nowrap;
        }
        #hearItOutLoudToggleBtn {
            flex-shrink: 0; /* Don't let this button shrink too much */
        }
        /* Drag and Drop Area */
        #dropZone {
            border: 3px dashed #99f6e4; /* Tailwind teal-200 */
            border-radius: 0.5rem; /* Tailwind rounded-lg */
            padding: 2rem;
            text-align: center;
            color: #0f766e; /* Tailwind teal-700 */
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
            margin-top: 1rem;
        }
        #dropZone.dragover-active {
            background-color: #ccfbf1; /* Tailwind teal-100 */
            border-color: #0d9488; /* Tailwind teal-600 */
        }
       
        /* New Login Form Styles */
        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.5rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: #0d9488;
            box-shadow: 0 0 0 2px rgba(13, 148, 136, 0.3);
        }
        .toggle-auth-link {
            color: #0d9488;
            cursor: pointer;
            text-decoration: underline;
        }

        /* Mobile Specific Adjustments */
        @media (max-width: 420px) { /* Slightly wider breakpoint for these general adjustments */
            .card {
                padding: 1rem; 
            }
            .game-card { 
                min-height: 100px; 
                padding: 0.5rem;  
                font-size: 0.875rem; 
            }
            #matchingGrid {
                gap: 0.5rem; 
            }
            .mcq-option-btn {
                padding: 0.6rem 0.8rem; 
                font-size: 0.875rem;
            }
            #mcqQuestion {
                min-height: 60px;
                font-size: 1rem;
            }

            #gameInfoBar {
                padding: 0.35rem;
                gap: 0.35rem;
            }
            #languageSelectionInGameContainer {
                min-width: 120px; 
                margin-left: 0.25rem;
            }
            #languageSelectionInGameContainer label,
            #languageSelectorInGame {
                font-size: 0.75rem; 
            }
            #languageSelectorInGame {
                padding: 0.35rem 0.25rem; /* More padding reduction */
                max-width: 120px; /* Prevent dropdown from becoming too wide */
            }
            #currentScoreDisplay {
                font-size: 1rem;
            }
            #maxScoreDisplay {
                font-size: 0.75rem;
            }
             #mistakeTracker {
                gap: 0.25rem; 
            }
            .capybara-life-icon {
                width: 1.5rem; height: 1.5rem;
            }
            #hearItOutLoudToggleBtn {
                padding: 0.25rem 0.5rem;
                font-size: 0.7rem;
            }
            #hearItOutLoudToggleBtn svg {
                width: 0.8rem; height: 0.8rem;
            }
            #gameHeader h2 { 
                font-size: 1.25rem; 
            }
            #gameHeader button { 
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
            .btn { 
                padding: 0.6rem 1rem;
                font-size: 0.875rem;
            }
            #mainSelectionSection .btn, #uploadSection .btn, #essentialsCategorySelectionSection .btn, #essentialsCategoryOptionsSection .btn, #gameSelectionSection .btn {
                padding: 0.75rem; 
                font-size: 0.9rem;
            }
            #dropZone {
                padding: 1rem;
                font-size: 0.9rem;
            }
        }
        @media (max-width: 360px) { /* For very small screens */
            #languageSelectionInGameContainer {
                flex-basis: 100%; /* Make speech selector take full width if it wraps */
                margin-left: 0;
                margin-right: 0;
            }
            #languageSelectorInGame {
                width: 100%; /* Make dropdown full width within its container */
                max-width: none;
            }
            #hearItOutLoudToggleBtn {
                font-size: 0.65rem;
                padding: 0.2rem 0.4rem;
            }
             #gameInfoBar {
                justify-content: center; /* Center items if they all wrap */
            }
             #scoreDisplayContainer {
                margin-left: 0; /* Reset margin if centered */
                align-items: center;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="min-h-screen flex flex-col items-center p-2 sm:p-4 md:p-6">

    <button id="musicToggleBtn" class="btn p-2 text-sm">
        <svg id="musicIconOn" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707A1 1 0 0112 5v14a1 1 0 01-1.707.707L5.586 15z" /></svg>
        <svg id="musicIconOff" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707A1 1 0 0112 5v14a1 1 0 01-1.707.707L5.586 15zM17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"/></svg>
        <span id="musicStatusText">Music: ON</span>
    </button>

    <div class="w-full max-w-3xl mx-auto"> 
        <header class="text-center mb-6 sm:mb-10">
            <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh7G7JZO-izPezsiQzlGVi10doRtWHuCKsp3u9txVRurU_ziVdRHtF5XswySzXYQMbLpJXCr3QvXSrSQdJIuzO9QeNIkjUKqHIayQZQUFQFP2bpmVr_5auHdT-lbCL8KaVkrjrbw5UJqJApeGTADnBy-r5G-CBhHOGsvuAy8cN7FyJxH8VrJHM2Bu4TqZo/s512/studybuddy.jpg" alt="StudyBuddy Logo" class="header-logo-image"
                 onerror="this.onerror=null; this.src='https://placehold.co/120x80/CCCCCC/000000?text=Logo';">
            <p class="text-2xl sm:text-3xl font-bold text-teal-700 mt-2">StudyBuddy</p>
            <p class="text-lg sm:text-xl text-teal-600 mt-1">Your fun way to master vocabulary!</p>
        </header>

        <!-- Login Section -->
        <section id="loginSection" class="card mb-8">
            <h2 id="authTitle" class="text-2xl font-semibold text-teal-700 mb-4 text-center">Login to Your Account</h2>
           
            <form id="authForm" class="space-y-4">
                <div>
                    <label for="emailInput" class="block text-sm font-medium text-gray-700">Email Address</label>
                    <input type="email" id="emailInput" class="form-input mt-1" required>
                </div>
                <div>
                    <label for="passwordInput" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="passwordInput" class="form-input mt-1" required>
                </div>
                <button type="submit" id="authSubmitBtn" class="btn btn-primary w-full p-3 text-lg">Login</button>
            </form>
            <p id="authError" class="text-red-500 text-sm text-center mt-2 h-5"></p>

            <div class="relative my-6">
                <div class="absolute inset-0 flex items-center" aria-hidden="true"><div class="w-full border-t border-gray-300"></div></div>
                <div class="relative flex justify-center"><span class="bg-white px-2 text-sm text-gray-500">or</span></div>
            </div>

            <button id="googleLoginBtn" class="btn btn-google w-full p-4 text-lg">
                <svg class="google-icon" viewBox="0 0 48 48" aria-hidden="true"><path fill="#4285F4" d="M45.12 24.5c0-1.56-.14-3.06-.4-4.5H24v8.51h11.84c-.51 2.75-2.06 5.08-4.39 6.64v5.52h7.11c4.16-3.83 6.56-9.47 6.56-16.17z"></path><path fill="#34A853" d="M24 46c6.48 0 11.93-2.13 15.89-5.82l-7.11-5.52c-2.17 1.45-4.92 2.3-8.78 2.3-6.76 0-12.47-4.55-14.51-10.61H2.3v5.7C6.32 40.57 14.56 46 24 46z"></path><path fill="#FBBC05" d="M9.49 27.9c-.4-1.18-.62-2.45-.62-3.79s.22-2.61.62-3.79V14.6H2.3C.83 17.53 0 20.65 0 24.11s.83 6.58 2.3 9.51l7.19-5.72z"></path><path fill="#EA4335" d="M24 8.71c3.55 0 6.63 1.23 9.13 3.63l6.3-6.3C35.91 2.25 30.47 0 24 0 14.56 0 6.32 5.43 2.3 14.6l7.19 5.71C11.53 14.26 17.24 8.71 24 8.71z"></path></svg>
                <span>Continue with Google</span>
            </button>
           
            <p id="authToggleText" class="text-center text-sm mt-4">
                Don't have an account? <span id="toggleToSignUp" class="toggle-auth-link">Sign Up</span>
            </p>
        </section>

        <!-- Main App Content (hidden by default) -->
        <div id="appContent" class="hidden w-full">
            <div class="flex justify-between items-center mb-4">
                <button id="addNotesBtn" class="btn btn-secondary text-sm py-2 px-3">Add / Manage Notes</button>
                <button id="logoutBtn" class="btn btn-danger text-sm py-2 px-3">Logout</button>
            </div>
            <section id="mainSelectionSection" class="card non-interactive-card mb-6 sm:mb-8">
                <h2 class="text-xl sm:text-2xl font-semibold text-teal-700 mb-4">Get Started</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                    <button id="showUploadSectionBtn" class="btn btn-primary p-4 sm:p-6 text-base sm:text-lg">Upload My Own List</button>
                    <button id="showEssentialsSectionBtn" class="btn btn-primary p-4 sm:p-6 text-base sm:text-lg">Study Essentials</button>
                </div>
            </section>

            <section id="uploadSection" class="card non-interactive-card mb-6 sm:mb-8 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl sm:text-2xl font-semibold text-teal-700">1. Upload Vocabulary</h2>
                    <button id="backToMainSelectionFromUploadBtn" class="btn btn-secondary text-xs sm:text-sm py-1 px-2">Back</button>
                </div>
                <div class="mb-4 p-3 sm:p-4 bg-teal-50 border border-teal-200 rounded-lg text-teal-800 text-sm sm:text-base">
                    <h3 class="font-semibold">CSV File Format:</h3>
                    <ul class="list-disc list-inside ml-2 sm:ml-4 text-xs sm:text-sm">
                        <li>Must be a CSV (Comma Separated Values) file.</li>
                        <li>The first row is assumed to be headers and will be ignored.</li>
                        <li>Column 1: Word/phrase in the language you are learning.</li>
                        <li>Column 2: Translation of the word/phrase (your language).</li>
                        <li>Example (Learning Tagalog, Translation English): <code>"kumusta","hello"</code></li>
                         <li>Fields containing commas or quotes must be enclosed in double quotes (e.g., <code>"word, with comma","translation"</code>).</li>
                        <li>A double quote within a quoted field should be represented as two double quotes (e.g., <code>"word with ""quote""","translation"</code>).</li>
                    </ul>
                </div>
                <div id="targetLanguageSelectorContainer" class="my-3 sm:my-4">
                    <label for="targetLanguageSelector" class="block mb-1 sm:mb-2 text-sm font-medium text-gray-900">Select Target Language (for Column 1 words):</label>
                    <select id="targetLanguageSelector" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-teal-500 focus:border-teal-500 block w-full p-2 sm:p-2.5">
                        <option value="en-US" selected>English (US)</option>
                        <option value="en-GB">English (UK)</option>
                        <option value="es-ES">Español (España)</option>
                        <option value="es-MX">Español (México)</option>
                        <option value="fr-FR">Français (France)</option>
                        <option value="de-DE">Deutsch (German)</option>
                        <option value="it-IT">Italiano (Italian)</option>
                        <option value="pt-PT">Português (Portugal)</option>
                        <option value="ja-JP">日本語 (Japanese)</option>
                        <option value="ko-KR">한국어 (Korean)</option>
                        <option value="zh-CN">中文 (简体 Chinese)</option>
                        <option value="nl-NL">Nederlands (Dutch)</option>
                        <option value="ru-RU">Русский (Russian)</option>
                        <option value="ar-SA">العربية (Arabic)</option>
                        <option value="hi-IN">हिन्दी (Hindi)</option>
                        <option value="tl-PH">Tagalog (Filipino)</option>
                    </select>
                </div>
                 <label for="csvFile" class="block mb-2 text-sm font-medium text-gray-900">Select CSV File or Drag & Drop Below:</label>
                <input type="file" id="csvFile" accept=".csv" class="block w-full text-sm text-gray-900 border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none focus:border-teal-500 p-2 sm:p-2.5 mb-2">
                <div id="dropZone">
                    <p>Drag & Drop CSV File Here</p>
                    <p class="text-xs mt-1">(or click the input field above)</p>
                </div>
                <button id="uploadBtn" class="btn btn-primary mt-3 sm:mt-4 w-full sm:w-auto">Load Vocabulary from Selected File</button>
                <p id="uploadStatus" class="text-sm text-slate-500 mt-2 h-5"></p>
            </section>

            <section id="essentialsCategorySelectionSection" class="card non-interactive-card mb-6 sm:mb-8 hidden">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl sm:text-2xl font-semibold text-teal-700">Study Essentials: Select a Category</h2>
                    <button id="backToMainSelectionFromEssentialsBtn" class="btn btn-secondary text-xs sm:text-sm py-1 px-2">Back</button>
                </div>
                <div id="essentialsCategoryButtonsContainer" class="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3"></div>
            </section>

            <section id="essentialsCategoryOptionsSection" class="card non-interactive-card mb-6 sm:mb-8 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="essentialsOptionsTitle" class="text-xl sm:text-2xl font-semibold text-teal-700">Category: [Name]</h2>
                    <button id="backToEssentialsCategoriesBtn" class="btn btn-secondary text-xs sm:text-sm py-1 px-2">Change Category</button>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                    <button id="reviewEssentialsCategoryBtn" class="btn btn-outline essentials-action-btn p-4 sm:p-6 text-base sm:text-lg">Review This Category</button>
                    <button id="playGamesWithEssentialsBtn" class="btn btn-outline essentials-action-btn p-4 sm:p-6 text-base sm:text-lg">Play Games with This Category</button>
                </div>
            </section>

            <section id="gameSelectionSection" class="card non-interactive-card mb-6 sm:mb-8 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl sm:text-2xl font-semibold text-teal-700">2. Select a Game</h2>
                    <button id="backToSourceSelectionBtn" class="btn btn-secondary text-xs sm:text-sm py-1 px-2">Back</button>
                </div>
                <div id="gameButtonsContainer" class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                    <button id="matchingBtn" class="btn btn-outline p-4 sm:p-6 text-base sm:text-lg">Matching Game</button>
                    <button id="multipleChoiceBtn" class="btn btn-outline p-4 sm:p-6 text-base sm:text-lg">Multiple Choice</button>
                    <button id="typeTranslationBtn" class="btn btn-outline p-4 sm:p-6 text-base sm:text-lg">Type Translation</button>
                    <button id="talkToMeBtn" class="btn btn-outline p-4 sm:p-6 text-base sm:text-lg">Talk to Me (Speak)</button>
                    <button id="fillInTheBlanksBtn" class="btn btn-outline p-4 sm:p-6 text-base sm:text-lg hidden">Fill in the Blanks</button>
                    <button id="findTheWordsBtn" class="btn btn-outline p-4 sm:p-6 text-base sm:text-lg">Find the Words</button>
                </div>
            </section>

            <section id="gameArea" class="card non-interactive-card hidden">
                <div id="gameHeader" class="flex justify-between items-center mb-2">
                     <h2 id="gameTitle" class="text-xl sm:text-2xl md:text-3xl font-semibold text-teal-700">Game</h2>
                     <button id="backToGameSelectionBtn" class="btn btn-secondary text-xs sm:text-sm py-1.5 px-2 sm:py-2 sm:px-3">Back to Games</button>
                </div>
                <div id="gameInfoBar">
                    <div class="flex items-center space-x-1 sm:space-x-2 flex-grow basis-1/3"> <div id="mistakeTracker" class="flex space-x-1"></div>
                         <div id="languageSelectionInGameContainer" class="hidden">
                             <label for="languageSelectorInGame" class="text-xs sm:text-sm text-slate-700">Speech:</label>
                             <select id="languageSelectorInGame" class="bg-gray-50 border border-gray-300 text-gray-900 text-xs sm:text-sm rounded-md sm:rounded-lg focus:ring-teal-500 focus:border-teal-500 block p-1.5 sm:p-2.5">
                                 <option value="en-US">English (US)</option>
                                 <option value="en-GB">English (UK)</option>
                                 <option value="es-ES">Español (España)</option>
                                 <option value="es-MX">Español (México)</option>
                                 <option value="fr-FR">Français (France)</option>
                                 <option value="de-DE">Deutsch (German)</option>
                                 <option value="it-IT">Italiano (Italian)</option>
                                 <option value="pt-PT">Português (Portugal)</option>
                                 <option value="ja-JP">日本語 (Japanese)</option>
                                 <option value="ko-KR">한국어 (Korean)</option>
                                 <option value="zh-CN">中文 (简体 Chinese)</option>
                                 <option value="nl-NL">Nederlands (Dutch)</option>
                                 <option value="ru-RU">Русский (Russian)</option>
                                 <option value="ar-SA">العربية (Arabic)</option>
                                 <option value="hi-IN">हिन्दी (Hindi)</option>
                                 <option value="tl-PH">Tagalog (Filipino)</option>
                             </select>
                         </div>
                    </div>
                    <div class="flex items-center justify-center flex-grow basis-1/3"> <button id="hearItOutLoudToggleBtn" class="btn btn-outline text-xs sm:text-sm py-1 px-1.5 sm:py-1 sm:px-2 hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 sm:h-4 sm:w-4 inline-block mr-0.5 sm:mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707A1 1 0 0112 5v14a1 1 0 01-1.707.707L5.586 15z"></path></svg>
                        <span id="hearItOutLoudBtnText">Hear: OFF</span>
                    </button>
                    </div>
                    <div id="scoreDisplayContainer" class="text-right flex-grow basis-1/3"> <div id="currentScoreDisplay" class="text-lg sm:text-xl font-semibold text-teal-600">Score: 0</div>
                         <div id="maxScoreDisplay" class="text-xs sm:text-sm text-teal-500">Max Score: 0</div>
                    </div>
                </div>
                <p id="ttsGeneralStatus" class="text-center text-xs text-red-500 mt-1 h-4"></p>
                <hr class="my-3 sm:my-4 border-teal-200">

                <div id="partSelectionContainer" class="hidden mb-4 sm:mb-6">
                    <h3 class="text-lg sm:text-xl font-semibold text-teal-700 mb-2 sm:mb-3">Choose a Part to Study:</h3>
                    <div id="partButtonsContainer" class="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3"></div>
                </div>

                <div id="matchingGame" class="hidden">
                    <p id="matchingInstructions" class="text-slate-600 mb-3 sm:mb-4 text-sm sm:text-base">Match Target Language to Your Language.</p>
                    <div id="matchingGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 sm:gap-3 md:gap-4"></div>
                    <p id="matchingFeedback" class="text-center font-medium mt-3 sm:mt-4 h-5 sm:h-6 text-sm sm:text-base"></p>
                    <div class="text-center mt-3 sm:mt-4">
                         <button id="resetCurrentPartBtn" class="btn btn-primary">Restart This Part</button>
                    </div>
                </div>

                 <div id="findTheWordsGame" class="hidden">
                    <p id="findTheWordsInstructions" class="text-slate-600 mb-2 text-sm sm:text-base">Listen carefully and select the words you hear (in the Target Language).</p>
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-3 sm:mb-4 gap-2">
                        <button id="replayFindTheWordsAudioBtn" class="btn btn-secondary text-xs sm:text-sm py-1.5 px-2 sm:py-2 sm:px-3 w-full sm:w-auto">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707A1 1 0 0112 5v14a1 1 0 01-1.707.707L5.586 15z"></path></svg>
                            Replay Audio
                        </button>
                        <span id="findTheWordsRoundCounter" class="text-xs sm:text-sm text-slate-500">Round: 1/5</span>
                    </div>
                    <div id="findTheWordsGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 sm:gap-3 mb-3 sm:mb-4"></div>
                    <button id="sendFindTheWordsBtn" class="btn btn-primary w-full sm:w-auto" disabled>Send Answer</button>
                    <p id="findTheWordsFeedback" class="text-center font-medium mt-3 sm:mt-4 h-5 sm:h-6 text-sm sm:text-base"></p>
                    <div class="text-center mt-4 sm:mt-6">
                        <button id="nextFindTheWordsRoundBtn" class="btn btn-primary hidden">Next Round</button>
                    </div>
                </div>

                <div id="multipleChoiceGame" class="hidden">
                    <p id="mcqInstructions" class="text-slate-600 mb-3 sm:mb-4 text-sm sm:text-base">Choose the correct Translation for the Target Language word.</p>
                    <div id="mcqQuestion" class="card non-interactive-card bg-sky-50 p-3 sm:p-4 mb-3 sm:mb-4 text-lg sm:text-xl font-medium text-sky-700 text-center min-h-[70px] sm:min-h-[80px] flex items-center justify-center"></div>
                    <div id="mcqOptions" class="space-y-2 sm:space-y-3"></div>
                    <p id="mcqFeedback" class="text-center font-medium mt-3 sm:mt-4 h-5 sm:h-6 text-sm sm:text-base"></p>
                    <div class="text-center mt-4 sm:mt-6">
                        <button id="nextMcqBtn" class="btn btn-primary hidden">Next Question</button>
                    </div>
                </div>

                <div id="typeTranslationGame" class="hidden">
                    <p id="typeTranslationInstructions" class="text-slate-600 mb-3 sm:mb-4 text-sm sm:text-base">Type the Target Language translation for the word/phrase shown in Your Language.</p>
                    <div id="typeTranslationPhrase" class="card non-interactive-card bg-sky-50 p-3 sm:p-4 mb-3 sm:mb-4 text-lg sm:text-xl font-medium text-sky-700 text-center min-h-[70px] sm:min-h-[80px] flex items-center justify-center"></div>
                    <input type="text" id="typeTranslationInput" class="w-full p-2.5 sm:p-3 border border-slate-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 mb-2 text-sm sm:text-base" placeholder="Type Target Language translation here...">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-3 sm:mb-4 gap-2">
                        <button id="hintTypeTranslationBtn" class="btn btn-warning text-xs sm:text-sm py-1.5 px-2 sm:py-2 sm:px-3 w-full sm:w-auto">Hint</button>
                        <p id="typeTranslationHintDisplay" class="text-xs sm:text-sm text-amber-700 h-5 flex-grow text-right pr-0 sm:pr-2"></p>
                    </div>
                    <button id="checkTypeTranslationBtn" class="btn btn-primary w-full sm:w-auto">Check Answer</button>
                    <p id="typeTranslationFeedback" class="text-center font-medium mt-3 sm:mt-4 h-5 sm:h-6 text-sm sm:text-base"></p>
                    <div class="text-center mt-4 sm:mt-6">
                        <button id="nextTypeTranslationBtn" class="btn btn-primary hidden">Next Phrase</button>
                    </div>
                     <p id="typeTranslationCounter" class="text-center text-xs sm:text-sm text-slate-500 mt-3 sm:mt-4"></p>
                </div>

                <div id="fillInTheBlanksGame" class="hidden">
                    <p id="fillInTheBlanksInstructions" class="text-slate-600 mb-3 sm:mb-4 text-sm sm:text-base">Fill in the blank with the correct English word (Essentials Mode Only).</p>
                    <div id="fillInTheBlanksSentence" class="card non-interactive-card bg-sky-50 p-4 sm:p-6 mb-3 sm:mb-4 text-lg sm:text-xl font-medium text-sky-700 text-center min-h-[80px] sm:min-h-[100px] flex items-center justify-center leading-relaxed"></div>
                    <input type="text" id="fillInTheBlanksInput" class="w-full p-2.5 sm:p-3 border border-slate-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 mb-3 sm:mb-4 text-sm sm:text-base" placeholder="Type the missing word...">
                    <button id="checkFillInTheBlanksBtn" class="btn btn-primary w-full sm:w-auto">Check Answer</button>
                    <p id="fillInTheBlanksFeedback" class="text-center font-medium mt-3 sm:mt-4 h-5 sm:h-6 text-sm sm:text-base"></p>
                    <div class="text-center mt-4 sm:mt-6">
                        <button id="nextFillInTheBlanksBtn" class="btn btn-primary hidden">Next Question</button>
                    </div>
                    <p id="fillInTheBlanksCounter" class="text-center text-xs sm:text-sm text-slate-500 mt-3 sm:mt-4"></p>
                </div>

                <div id="talkToMeGame" class="hidden">
                    <p id="talkToMeInstructions" class="text-slate-600 mb-2 text-sm sm:text-base">Read the Target Language phrase aloud.</p>
                    <div id="talkToMePhraseToRead" class="card non-interactive-card bg-sky-100 border-sky-300 p-4 sm:p-6 mb-3 sm:mb-4 text-xl sm:text-2xl font-semibold text-sky-800 text-center relative">
                        <span id="talkToMePhraseText"></span>
                        <button id="speakPhraseBtn" class="btn btn-outline p-1 absolute bottom-1 sm:bottom-2 left-1/2 transform -translate-x-1/2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM12.293 7.293a1 1 0 011.414 0L15 8.586l1.293-1.293a1 1 0 111.414 1.414L16.414 10l1.293 1.293a1 1 0 01-1.414 1.414L15 11.414l-1.293 1.293a1 1 0 01-1.414-1.414L13.586 10l-1.293-1.293a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                    <div class="flex flex-col sm:flex-row items-center justify-center space-y-2 sm:space-y-0 sm:space-x-3 mb-3 sm:mb-4">
                        <button id="listenBtn" class="btn btn-primary w-full sm:w-auto">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5 inline-block mr-1 sm:mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H7a1 1 0 100 2h6a1 1 0 100-2h-2v-2.07z" clip-rule="evenodd" /></svg>
                            <span id="listenBtnText">Start Listening</span>
                        </button>
                        <button id="nextTalkToMeBtn" class="btn btn-secondary w-full sm:w-auto hidden">Next Phrase</button>
                    </div>
                    <div class="my-2 sm:my-3 p-2 sm:p-3 bg-slate-50 rounded-lg border border-slate-200">
                        <p class="text-xs sm:text-sm text-slate-500 mb-1">What I heard:</p>
                        <p id="talkToMeRecognizedText" class="text-slate-700 font-medium italic text-sm sm:text-base">...</p>
                    </div>
                    <p id="talkToMeFeedback" class="text-center font-medium mt-2 sm:mt-3 h-5 sm:h-6 text-sm sm:text-base"></p>
                    <div id="talkToMeReferenceContainer" class="mt-2 sm:mt-3 p-2 sm:p-3 bg-emerald-50 rounded-lg border border-emerald-200 hidden">
                         <p id="talkToMeReferenceLabel" class="text-xs sm:text-sm text-emerald-600 mb-1">Your Language Translation:</p>
                         <p id="talkToMeReferenceDisplay" class="text-emerald-700 font-medium text-sm sm:text-base"></p>
                    </div>
                    <p id="talkToMeCounter" class="text-center text-xs sm:text-sm text-slate-500 mt-3 sm:mt-4"></p>
                    <p id="speechApiStatus" class="text-center text-xs text-red-500 mt-1 sm:mt-2 h-4"></p>
                </div>

                <div id="roundCompleteMessage" class="hidden"></div>
                <div id="bonusRoundCountdownMessage" class="hidden"></div>
                <p id="gameOverMessage" class="text-center text-xl sm:text-2xl font-bold text-red-600 my-4 sm:my-6 hidden"></p>
                <p id="noVocabularyMessage" class="text-center text-red-500 hidden">Please upload a vocabulary list first.</p>
            </section>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {     
          
            // --- Supabase Client Setup ---
            const { createClient } = supabase;
            const SUPABASE_URL = 'https://yxngigimphtfoslzmksn.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4bmdpZ2ltcGh0Zm9zbHpta3NuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwMjk2NDUsImV4cCI6MjA2ODYwNTY0NX0.c4b45vxCOnmLV6VY7w0DsPr2cAzRf9zNbqaXkKaWmYQ';
            const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // --- STATE & CONSTANTS ---
            const MAX_MISTAKES = 3, FAST_ANSWER_THRESHOLD = 5e3, POINTS_CORRECT_TALK_TO_ME = 5, POINTS_FAST_CORRECT = 10, POINTS_SLOW_CORRECT = 5, POINTS_INCORRECT = -10, ITEMS_PER_PART = 32, ITEMS_PER_SUB_ROUND = 8, MAX_GAME_ITEMS_FILL_BLANKS = 10, TEXT_TRUNCATE_LENGTH = 60, MAX_FIND_WORDS_ROUNDS = 5, WORDS_PER_FIND_WORDS_DISPLAY = 8, WORDS_PER_FIND_WORDS_TARGET = 3, FIND_WORDS_REQUIRED_VOCAB = 15;
            let vocabulary = [], csvUploadedTargetLanguage = "en-US", activeTargetStudyLanguage = "en-US", recognition, isListening = false, isSignUp = false;
            let currentVocabularyPart = [], currentPartName = "", mistakesRemaining = 3, currentScore = 0, sessionMaxScore = 0;
            let isEssentialsMode = false, currentEssentialsCategoryName = "";
            let audioInitialized = false;
            let mcqAnswered = false, typeTranslationAnswered = false, fillBlanksAnswered = false;
            let currentMcqIndex = 0, currentTypeTranslationIndex = 0, currentFillBlanksIndex = 0;
            let findWordsSessionPool = [], currentFindWordsRound = 0, findWordsCurrentChoices = [], findWordsTargetWords = [], findWordsSelectedWords = [];
            let selectedMatchCard = null, matchedPairs = 0, pairsToMatch = 0;

            // --- ELEMENT SELECTORS ---
            const loginSection = document.getElementById('loginSection'), appContent = document.getElementById('appContent'), logoutBtn = document.getElementById('logoutBtn'), googleLoginBtn = document.getElementById('googleLoginBtn'), authForm = document.getElementById('authForm'), authTitle = document.getElementById('authTitle'), authSubmitBtn = document.getElementById('authSubmitBtn'), authToggleText = document.getElementById('authToggleText'), authError = document.getElementById('authError'), addNotesBtn = document.getElementById('addNotesBtn');
            const mainSelectionSection = document.getElementById("mainSelectionSection"), showUploadSectionBtn = document.getElementById("showUploadSectionBtn"), showEssentialsSectionBtn = document.getElementById("showEssentialsSectionBtn"), csvFileInput = document.getElementById("csvFile"), targetLanguageSelector = document.getElementById("targetLanguageSelector"), languageSelectorInGame = document.getElementById("languageSelectorInGame"), languageSelectionInGameContainer = document.getElementById("languageSelectionInGameContainer"), uploadBtn = document.getElementById("uploadBtn"), uploadStatus = document.getElementById("uploadStatus"), uploadSection = document.getElementById("uploadSection"), dropZone = document.getElementById("dropZone"), backToMainSelectionFromUploadBtn = document.getElementById("backToMainSelectionFromUploadBtn"), essentialsCategorySelectionSection = document.getElementById("essentialsCategorySelectionSection"), essentialsCategoryButtonsContainer = document.getElementById("essentialsCategoryButtonsContainer"), backToMainSelectionFromEssentialsBtn = document.getElementById("backToMainSelectionFromEssentialsBtn"), essentialsCategoryOptionsSection = document.getElementById("essentialsCategoryOptionsSection"), essentialsOptionsTitle = document.getElementById("essentialsOptionsTitle"), reviewEssentialsCategoryBtn = document.getElementById("reviewEssentialsCategoryBtn"), playGamesWithEssentialsBtn = document.getElementById("playGamesWithEssentialsBtn"), backToEssentialsCategoriesBtn = document.getElementById("backToEssentialsCategoriesBtn"), gameSelectionSection = document.getElementById("gameSelectionSection"), gameButtonsContainer = document.getElementById("gameButtonsContainer"), backToSourceSelectionBtn = document.getElementById("backToSourceSelectionBtn"), gameArea = document.getElementById("gameArea"), noVocabularyMessage = document.getElementById("noVocabularyMessage"), gameOverMessage = document.getElementById("gameOverMessage"), roundCompleteMessageDiv = document.getElementById("roundCompleteMessage"), bonusRoundCountdownMessageDiv = document.getElementById("bonusRoundCountdownMessage"), matchingBtn = document.getElementById("matchingBtn"), multipleChoiceBtn = document.getElementById("multipleChoiceBtn"), typeTranslationBtn = document.getElementById("typeTranslationBtn"), talkToMeBtn = document.getElementById("talkToMeBtn"), fillInTheBlanksBtn = document.getElementById("fillInTheBlanksBtn"), findTheWordsBtn = document.getElementById("findTheWordsBtn"), backToGameSelectionBtn = document.getElementById("backToGameSelectionBtn"), gameTitle = document.getElementById("gameTitle"), musicToggleBtn = document.getElementById("musicToggleBtn"), musicIconOn = document.getElementById("musicIconOn"), musicIconOff = document.getElementById("musicIconOff"), musicStatusText = document.getElementById("musicStatusText"), mistakeTrackerDiv = document.getElementById("mistakeTracker"), currentScoreDisplay = document.getElementById("currentScoreDisplay"), maxScoreDisplay = document.getElementById("maxScoreDisplay"), partSelectionContainer = document.getElementById("partSelectionContainer"), partButtonsContainer = document.getElementById("partButtonsContainer");
            const matchingGameContainer = document.getElementById("matchingGame"), matchingGrid = document.getElementById("matchingGrid"), matchingInstructions = document.getElementById("matchingInstructions"), matchingFeedback = document.getElementById("matchingFeedback"), resetCurrentPartBtn = document.getElementById("resetCurrentPartBtn"), multipleChoiceGameContainer = document.getElementById("multipleChoiceGame"), mcqInstructions = document.getElementById("mcqInstructions"), mcqQuestion = document.getElementById("mcqQuestion"), mcqOptions = document.getElementById("mcqOptions"), mcqFeedback = document.getElementById("mcqFeedback"), nextMcqBtn = document.getElementById("nextMcqBtn");
            const typeTranslationGameContainer = document.getElementById("typeTranslationGame"), typeTranslationInstructions = document.getElementById("typeTranslationInstructions"), typeTranslationPhrase = document.getElementById("typeTranslationPhrase"), typeTranslationInput = document.getElementById("typeTranslationInput"), hintTypeTranslationBtn = document.getElementById("hintTypeTranslationBtn"), typeTranslationHintDisplay = document.getElementById("typeTranslationHintDisplay"), checkTypeTranslationBtn = document.getElementById("checkTypeTranslationBtn"), typeTranslationFeedback = document.getElementById("typeTranslationFeedback"), nextTypeTranslationBtn = document.getElementById("nextTypeTranslationBtn"), typeTranslationCounter = document.getElementById("typeTranslationCounter");
            const fillInTheBlanksGameContainer = document.getElementById("fillInTheBlanksGame"), fillInTheBlanksInstructions = document.getElementById("fillInTheBlanksInstructions"), fillInTheBlanksSentence = document.getElementById("fillInTheBlanksSentence"), fillInTheBlanksInput = document.getElementById("fillInTheBlanksInput"), checkFillInTheBlanksBtn = document.getElementById("checkFillInTheBlanksBtn"), fillInTheBlanksFeedback = document.getElementById("fillInTheBlanksFeedback"), nextFillInTheBlanksBtn = document.getElementById("nextFillInTheBlanksBtn"), fillInTheBlanksCounter = document.getElementById("fillInTheBlanksCounter");
            const findTheWordsGameContainer = document.getElementById("findTheWordsGame"), findTheWordsInstructions = document.getElementById("findTheWordsInstructions"), replayFindTheWordsAudioBtn = document.getElementById("replayFindTheWordsAudioBtn"), findTheWordsRoundCounter = document.getElementById("findTheWordsRoundCounter"), findTheWordsGrid = document.getElementById("findTheWordsGrid"), sendFindTheWordsBtn = document.getElementById("sendFindTheWordsBtn"), findTheWordsFeedback = document.getElementById("findTheWordsFeedback"), nextFindTheWordsRoundBtn = document.getElementById("nextFindTheWordsRoundBtn"), talkToMeGameContainer = document.getElementById("talkToMeGame"), talkToMeInstructions = document.getElementById("talkToMeInstructions"), talkToMePhraseToRead = document.getElementById("talkToMePhraseToRead"), talkToMePhraseText = document.getElementById("talkToMePhraseText"), speakPhraseBtn = document.getElementById("speakPhraseBtn"), listenBtn = document.getElementById("listenBtn"), listenBtnText = document.getElementById("listenBtnText"), nextTalkToMeBtn = document.getElementById("nextTalkToMeBtn"), talkToMeRecognizedText = document.getElementById("talkToMeRecognizedText"), talkToMeFeedback = document.getElementById("talkToMeFeedback"), talkToMeReferenceContainer = document.getElementById("talkToMeReferenceContainer"), talkToMeReferenceLabel = document.getElementById("talkToMeReferenceLabel"), talkToMeReferenceDisplay = document.getElementById("talkToMeReferenceDisplay"), talkToMeCounter = document.getElementById("talkToMeCounter"), speechApiStatus = document.getElementById("speechApiStatus"), hearItOutLoudToggleBtn = document.getElementById("hearItOutLoudToggleBtn"), hearItOutLoudBtnText = document.getElementById("hearItOutLoudBtnText"), ttsGeneralStatus = document.getElementById("ttsGeneralStatus");

            // Make the "Talk to Me" phrase speak when clicked
            
            if (talkToMePhraseText) {
    talkToMePhraseText.onclick = () => {
        const word = talkToMePhraseText.textContent.trim();
        if (word) speakText(word, activeTargetStudyLanguage);
    };
}
            // --- DATA ---
            const essentialsVocabularyData = { "Travel (EN-ES)": [{ lang1: "passport", lang2: "pasaporte", sentence: "You need a ____ to travel abroad.", correctCount: 0, originalIndex: 0 }, { lang1: "ticket", lang2: "billete", sentence: "I bought a round-trip ____ to Paris.", correctCount: 0, originalIndex: 1 }, { lang1: "luggage", lang2: "equipaje", sentence: "My ____ was too heavy.", correctCount: 0, originalIndex: 2 }, { lang1: "destination", lang2: "destino", sentence: "Our final ____ is Rome.", correctCount: 0, originalIndex: 3 }, { lang1: "reservation", lang2: "reserva", sentence: "I made a hotel ____ online.", correctCount: 0, originalIndex: 4 }], "Business (EN-ES)": [{ lang1: "meeting", lang2: "reunión", sentence: "The client ____ is at 2 PM.", correctCount: 0, originalIndex: 0 }, { lang1: "contract", lang2: "contrato", sentence: "Please review the ____ carefully.", correctCount: 0, originalIndex: 1 }, { lang1: "negotiation", lang2: "negociación", sentence: "The ____ lasted for hours.", correctCount: 0, originalIndex: 2 }, { lang1: "deadline", lang2: "fecha límite", sentence: "We must meet the project ____.", correctCount: 0, originalIndex: 3 }, { lang1: "presentation", lang2: "presentación", sentence: "She gave an excellent ____.", correctCount: 0, originalIndex: 4 }], "Food (EN-FR)": [{ lang1: "bread", lang2: "pain", sentence: "I would like some ____, please.", correctCount: 0, originalIndex: 0 }, { lang1: "water", lang2: "eau", sentence: "Can I have a glass of ____?", correctCount: 0, originalIndex: 1 }] };
            Object.values(essentialsVocabularyData).forEach(e => { e.forEach((e, t) => { if (e.originalIndex === undefined) e.originalIndex = t; if (e.correctCount === undefined) e.correctCount = 0; }) });



            // --- AUTHENTICATION & DATA FUNCTIONS ---
            function toggleAuthMode() {
                isSignUp = !isSignUp;
                authError.textContent = '';
                authForm.reset();
                authTitle.textContent = isSignUp ? 'Create a New Account' : 'Login to Your Account';
                authSubmitBtn.textContent = isSignUp ? 'Sign Up' : 'Login';
                authToggleText.innerHTML = isSignUp
                    ? `Already have an account? <span class="toggle-auth-link">Login</span>`
                    : `Don't have an account? <span class="toggle-auth-link">Sign Up</span>`;
            }

            async function fetchNotes() {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) {
                    vocabulary = [];
                    return;
                }
                const { data, error } = await supabaseClient
                    .from('notes')
                    .select('term, definition, term_lang')
                    .eq('user_id', user.id);
                if (error) {
                    console.error('Error fetching notes:', error);
                    vocabulary = [];
                } else {
                    vocabulary = data.map((note, index) => ({
                        lang1: note.term,
                        lang2: note.definition,
                        originalIndex: index,
                    }));
                }
            }
            
            function parseCSV(csvData) {
                const parsed = [];
                const lines = csvData.split(/\r\n|\n/);
                
                // Skip header row if it exists
                const startIndex = lines.length > 0 && lines[0].toLowerCase().includes('word') ? 1 : 0;

                for (let i = startIndex; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line === '') continue;
                    
                    const parts = [];
                    let currentField = '';
                    let inQuotedField = false;
                    
                    for (let j = 0; j < line.length; j++) {
                        const char = line[j];
                        if (char === '"') {
                            if (inQuotedField && j + 1 < line.length && line[j + 1] === '"') {
                                currentField += '"';
                                j++; 
                            } else {
                                inQuotedField = !inQuotedField;
                            }
                        } else if (char === ',' && !inQuotedField) {
                            parts.push(currentField.trim());
                            currentField = '';
                        } else {
                            currentField += char;
                        }
                    }
                    parts.push(currentField.trim()); 

                    if (parts.length >= 2 && parts[0] && parts[1]) {
                        parsed.push({
                            lang1: parts[0],
                            lang2: parts[1]
                        });
                    }
                }
                return parsed;
            }

async function saveNotes(notesToSave) {
    console.log('saveNotes called with:', notesToSave);

    const userResult = await supabaseClient.auth.getUser();
    console.log('userResult:', userResult);

    const user = userResult?.data?.user;
    if (!user) {
        uploadStatus.textContent = 'You must be logged in to save notes.';
        uploadStatus.className = 'text-sm text-red-600 mt-2 h-5';
        return false;
    }

    const notesWithUser = notesToSave.map(note => ({
        user_id: user.id,
        term: note.lang1,
        definition: note.lang2,
        term_lang: csvUploadedTargetLanguage,
        definition_lang: 'en'
    }));
    console.log('Inserting into supabase:', notesWithUser);

    const { data, error } = await supabaseClient.from('notes').insert(notesWithUser);
    console.log('Supabase insert result:', data, error);

    if (error) {
        console.error('Error saving notes:', error);
        uploadStatus.textContent = 'Error saving notes: ' + error.message;
        uploadStatus.className = 'text-sm text-red-600 mt-2 h-5';
        return false;
    }
    return true;
}
            async function handleFileUpload(droppedFile = null) {
                console.log('handleFileUpload called'); // <--- add
                const file = droppedFile || (csvFileInput.files.length > 0 ? csvFileInput.files[0] : null);
                if (!file) {
                    uploadStatus.textContent = 'Please select or drop a CSV file.';
                    uploadStatus.className = 'text-sm text-red-600 mt-2 h-5';
                    return;
                }
                
                if (!(file.type === "text/csv" || file.name.toLowerCase().endsWith(".csv"))) {
                    uploadStatus.textContent = 'Invalid file type. Please use a CSV file.';
                    uploadStatus.className = 'text-sm text-red-600 mt-2 h-5';
                    return;
                }
                
                csvUploadedTargetLanguage = targetLanguageSelector.value;
                uploadStatus.textContent = 'Processing CSV file...';
                uploadStatus.className = 'text-sm text-blue-600 mt-2 h-5';
                
                const reader = new FileReader();
                reader.onload = async function(event) {
                    try {
                         console.log('FileReader loaded:', event.target.result.slice(0,100)); // <--- add preview
                        const parsedNotes = parseCSV(event.target.result);
                           console.log('Parsed notes:', parsedNotes); // <--- add
                        if (parsedNotes.length > 0) {
                            uploadStatus.textContent = 'Saving notes to your account...';
                            uploadStatus.className = 'text-sm text-blue-600 mt-2 h-5';
                            const success = await saveNotes(parsedNotes);
                            if (success) {
                                await fetchNotes();
                                uploadStatus.textContent = `Successfully saved ${parsedNotes.length} new notes!`;
                                uploadStatus.className = 'text-sm text-green-600 mt-2 h-5';
                                isEssentialsMode = false;
                                setTimeout(() => {
                                    uploadSection.classList.add('hidden');
                                    showGameSelection();
                                }, 1500);
                            }
                        } else {
                            uploadStatus.textContent = 'No vocabulary found. Check file format.';
                            uploadStatus.className = 'text-sm text-red-600 mt-2 h-5';
                        }
                    } catch (error) {
                        uploadStatus.textContent = 'Error processing CSV file.';
                        uploadStatus.className = 'text-sm text-red-600 mt-2 h-5';
                        console.error("Error processing CSV:", error);
                    }
                };
                reader.onerror = () => {
                    uploadStatus.textContent = 'Error reading file.';
                    uploadStatus.className = 'text-sm text-red-600 mt-2 h-5';
                };
                reader.readAsText(file);
            }

            // --- UI & NAVIGATION ---
            function hideAllGames() { [matchingGameContainer, multipleChoiceGameContainer, typeTranslationGameContainer, talkToMeGameContainer, fillInTheBlanksGameContainer, findTheWordsGameContainer, gameOverMessage, roundCompleteMessageDiv, bonusRoundCountdownMessageDiv].forEach(el => el.classList.add('hidden')); }
            function showGameInfoBar() { [mistakeTrackerDiv, currentScoreDisplay, maxScoreDisplay].forEach(el => el.classList.remove('hidden')); }
            function showMainSelection() { 
                mainSelectionSection.classList.remove('hidden'); 
                [uploadSection, essentialsCategorySelectionSection, essentialsCategoryOptionsSection, gameSelectionSection, gameArea, partSelectionContainer].forEach(el => el && el.classList.add('hidden')); 
                isEssentialsMode = false; 
            }
            function showGameSelection() {
                if (!isEssentialsMode) {
                    activeTargetStudyLanguage = csvUploadedTargetLanguage; 
                } 
                [mainSelectionSection, uploadSection, essentialsCategorySelectionSection, essentialsCategoryOptionsSection, partSelectionContainer, gameArea].forEach(el => el.classList.add('hidden'));
                hideAllGames();
                gameSelectionSection.classList.remove('hidden');
                fillInTheBlanksBtn.classList.toggle('hidden', !isEssentialsMode); 
                findTheWordsBtn.classList.remove('hidden'); 
                const activeVocab = isEssentialsMode ? currentVocabularyPart : vocabulary;
                if (activeVocab.length === 0) { 
                    noVocabularyMessage.classList.remove('hidden'); 
                    gameButtonsContainer.classList.add('hidden'); 
                } else { 
                    noVocabularyMessage.classList.add('hidden'); 
                    gameButtonsContainer.classList.remove('hidden'); 
                }
            }
            function populateEssentialsCategoryButtons() { 
                essentialsCategoryButtonsContainer.innerHTML = ''; 
                Object.keys(essentialsVocabularyData).forEach(categoryKey => { 
                    const button = document.createElement('button'); 
                    button.className = 'btn essentials-category-btn p-3 sm:p-4 text-sm sm:text-md'; 
                    button.textContent = categoryKey; 
                    button.addEventListener('click', () => { 
                        currentEssentialsCategoryName = categoryKey; 
                        isEssentialsMode = true; 
                        if (categoryKey.toLowerCase().includes("(en-es)")) { 
                            activeTargetStudyLanguage = 'es-ES'; 
                        } else if (categoryKey.toLowerCase().includes("(en-fr)")) { 
                            activeTargetStudyLanguage = 'fr-FR'; 
                        } else { 
                            activeTargetStudyLanguage = 'en-US'; 
                        } 
                        currentVocabularyPart = essentialsVocabularyData[categoryKey].map((item, index) => ({
                            ...item, 
                            originalIndex: index, 
                            correctCount: item.correctCount || 0 
                        })); 
                        essentialsOptionsTitle.textContent = `Category: ${categoryKey}`; 
                        essentialsCategorySelectionSection.classList.add('hidden'); 
                        essentialsCategoryOptionsSection.classList.remove('hidden'); 
                    }); 
                    essentialsCategoryButtonsContainer.appendChild(button); 
                }); 
            }
            
            function showPartSelection(gameType) {
                const sourceForParts = isEssentialsMode ? currentVocabularyPart : vocabulary;
                if (sourceForParts.length === 0) { 
                    noVocabularyMessage.classList.remove('hidden'); 
                    gameArea.classList.remove('hidden'); 
                    [partSelectionContainer, matchingGameContainer, multipleChoiceGameContainer, typeTranslationGameContainer, talkToMeGameContainer, fillInTheBlanksGameContainer, findTheWordsGameContainer, gameOverMessage].forEach(el => el.classList.add('hidden')); 
                    return; 
                }
                gameTitle.textContent = gameType.charAt(0).toUpperCase() + gameType.slice(1).replace(/([A-Z])/g, ' $1');
                [uploadSection, gameSelectionSection, essentialsCategorySelectionSection, essentialsCategoryOptionsSection, mainSelectionSection].forEach(el => el.classList.add('hidden'));
                gameArea.classList.remove('hidden');
                partSelectionContainer.classList.remove('hidden');
                hideAllGames();
                partButtonsContainer.innerHTML = '';
                const numParts = Math.ceil(sourceForParts.length / ITEMS_PER_PART);
                const fullMixButton = document.createElement('button');
                fullMixButton.className = 'btn part-selection-btn p-3 sm:p-4 text-sm sm:text-md';
                fullMixButton.textContent = `Full Mix (${sourceForParts.length} items)`;
                fullMixButton.addEventListener('click', () => { 
                    currentVocabularyPart = [...sourceForParts]; 
                    currentPartName = "Full Mix"; 
                    startGame(gameType); 
                });
                partButtonsContainer.appendChild(fullMixButton);
                if (!isEssentialsMode && numParts > 1 && sourceForParts.length > ITEMS_PER_PART) {
                    for (let i = 0; i < numParts; i++) {
                        const start = i * ITEMS_PER_PART;
                        const end = start + ITEMS_PER_PART;
                        const partVocab = sourceForParts.slice(start, end);
                        if (partVocab.length === 0) continue;
                        const button = document.createElement('button');
                        button.className = 'btn part-selection-btn p-3 sm:p-4 text-sm sm:text-md';
                        button.textContent = `Part ${i + 1} (Items ${start + 1}-${Math.min(end, sourceForParts.length)})`;
                        button.addEventListener('click', () => { 
                            currentVocabularyPart = partVocab; 
                            currentPartName = `Part ${i + 1}`; 
                            startGame(gameType); 
                        });
                        partButtonsContainer.appendChild(button);
                    }
                }
            }
            
            function startGame(gameType) {
                if (!audioInitialized) initializeAudio();
                partSelectionContainer.classList.add('hidden');
                resetGameStats();
                switch (gameType) {
                    case 'matching': initMatchingGame(); break;
                    case 'multipleChoice': initMultipleChoiceGame(); break;
                    case 'typeTranslation': initTypeTranslationGame(); break;
                    case 'talkToMe': initTalkToMeGame(); break;
                    case 'fillInTheBlanks': initFillInTheBlanksGame(); break;
                    case 'findTheWords': initFindTheWordsGame(); break;
                }
            }

            // --- HELPER & CORE GAME MECHANICS ---
            function shuffleArray(array) { 
                const newArray = [...array]; 
                for (let i = newArray.length - 1; i > 0; i--) { 
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArray[i], newArray[j]] = [newArray[j], newArray[i]]; 
                } 
                return newArray; 
            }
            function normalizeText(text) { 
                return text.trim().toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,""); 
            }
            function updateScoreDisplay() { 
                currentScoreDisplay.textContent = `Score: ${currentScore}`; 
                maxScoreDisplay.textContent = `Max Score: ${sessionMaxScore}`; 
            }
            function setupMistakeTracker() { 
                mistakeTrackerDiv.innerHTML = ''; 
                for (let i = 0; i < MAX_MISTAKES; i++) { 
                    const capybaraSvg = document.createElementNS("http://www.w3.org/2000/svg", "svg"); 
                    capybaraSvg.setAttribute("viewBox", "0 0 60 60"); 
                    capybaraSvg.setAttribute("fill", "currentColor"); 
                    capybaraSvg.classList.add("capybara-life-icon"); 
                    capybaraSvg.innerHTML = ` <path d="M30,15 C18,15 10,23 10,33 C10,43 15,50 22,52 C20,48 20,42 23,40 C25,38 28,38 30,39 C32,38 35,38 37,40 C40,42 40,48 38,52 C45,50 50,43 50,33 C50,23 42,15 30,15 Z M22,28 A2,2 0 0,1 24,30 A2,2 0 0,1 22,32 A2,2 0 0,1 20,30 A2,2 0 0,1 22,28 Z M38,28 A2,2 0 0,1 40,30 A2,2 0 0,1 38,32 A2,2 0 0,1 36,30 A2,2 0 0,1 38,28 Z M30,42 C28,42 27,41 27,40 C27,39 28,38 30,38 C32,38 33,39 33,40 C33,41 32,42 30,42 Z"></path> <ellipse cx="23" cy="25" rx="3" ry="2" fill="#4a2c2a"/> <ellipse cx="37" cy="25" rx="3" ry="2" fill="#4a2c2a"/> <path d="M28,33 Q30,35 32,33" stroke="#4a2c2a" stroke-width="1.5" fill="none" /> `; 
                    mistakeTrackerDiv.appendChild(capybaraSvg); 
                } 
            }
            function updateMistakeDisplay() { 
                const icons = mistakeTrackerDiv.querySelectorAll('.capybara-life-icon'); 
                icons.forEach((icon, index) => icon.classList.toggle('mistake', index < MAX_MISTAKES - mistakesRemaining)); 
            }
            function resetGameStats() { 
                mistakesRemaining = MAX_MISTAKES; 
                updateScoreDisplay(); 
                setupMistakeTracker(); 
                gameOverMessage.classList.add('hidden'); 
            }
            
            // --- SPEECH & AUDIO ---
            function initializeAudio() {
                if (audioInitialized) return;
                audioInitialized = true;
                console.log("Audio initialized");
            }

            function speakText(text, lang) {
                return new Promise((resolve) => {
                    if ('speechSynthesis' in window && text) {
                        const utterance = new SpeechSynthesisUtterance(text);
                        utterance.lang = lang;
                        utterance.onend = resolve;
                        utterance.onerror = () => resolve();
                        window.speechSynthesis.speak(utterance);
                    } else {
                        resolve();
                    }
                });
            }

            function initSpeechRecognition() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SpeechRecognition) {
                    recognition = new SpeechRecognition();
                    recognition.continuous = false;
                    recognition.lang = 'en-US';
                    recognition.interimResults = false;
                    recognition.maxAlternatives = 1;

                    recognition.onresult = (event) => {
                        const speechResult = event.results[0][0].transcript;
                        talkToMeRecognizedText.textContent = speechResult;
                        checkSpeechAnswer(speechResult);
                    };
                    recognition.onerror = (event) => { 
                        speechApiStatus.textContent = `Error: ${event.error}`; 
                        stopListening(); 
                    };
                    recognition.onend = () => { 
                        if (isListening) stopListening(); 
                    };
                } else {
                    speechApiStatus.textContent = "Browser doesn't support speech recognition.";
                    if(listenBtn) listenBtn.disabled = true;
                }
            }

            // --- GAME LOGIC FUNCTIONS ---
            function initMatchingGame() {
                let gameVocab = shuffleArray(currentVocabularyPart).slice(0, ITEMS_PER_SUB_ROUND);
                pairsToMatch = gameVocab.length;
                let cards = [];
                gameVocab.forEach((item, index) => {
                    cards.push({ id: index, type: 'lang1', text: item.lang1 });
                    cards.push({ id: index, type: 'lang2', text: item.lang2 });
                });

                matchingGameContainer.classList.remove('hidden');
                matchingGrid.innerHTML = '';
                shuffleArray(cards).forEach(cardData => {
                    const cardElement = document.createElement('div');
                    cardElement.className = 'game-card card p-2';
                    cardElement.textContent = cardData.text;
                    cardElement.dataset.id = cardData.id;
                    cardElement.addEventListener('click', () => handleMatchCardClick(cardElement));
                    matchingGrid.appendChild(cardElement);
                });
            }

            function handleMatchCardClick(cardElement) {
                if (cardElement.classList.contains('matched') || cardElement === selectedMatchCard) return;
                if (!selectedMatchCard) {
                    selectedMatchCard = cardElement;
                    cardElement.classList.add('selected-match');
                } else {
                    if (selectedMatchCard.dataset.id === cardElement.dataset.id) {
                        [selectedMatchCard, cardElement].forEach(el => {
                            el.classList.add('matched');
                            el.classList.remove('selected-match');
                        });
                        matchedPairs++;
                        if (matchedPairs === pairsToMatch) matchingFeedback.textContent = "Part Complete!";
                    } else {
                        [selectedMatchCard, cardElement].forEach(el => el.classList.add('incorrect-match-animation'));
                        setTimeout(() => {
                            [selectedMatchCard, cardElement].forEach(el => el.classList.remove('incorrect-match-animation', 'selected-match'));
                            selectedMatchCard = null;
                        }, 400);
                    }
                    if (selectedMatchCard) selectedMatchCard = null;
                }
            }
function initMultipleChoiceGame() {
    let mcqGameActiveVocab = shuffleArray(currentVocabularyPart);
    currentMcqIndex = 0;
    mcqAnswered = false;
    multipleChoiceGameContainer.classList.remove('hidden');
    mcqFeedback.textContent = '';
    // Clear any old styles or options
    if (mcqOptions) mcqOptions.innerHTML = '';
    displayNextMcq(mcqGameActiveVocab);
}

        function displayNextMcq(gameVocab) {
    if (currentMcqIndex >= gameVocab.length) {
        mcqQuestion.textContent = "Part Complete!";
        mcqOptions.innerHTML = '';
        return;
    }
    const currentItem = gameVocab[currentMcqIndex];
    mcqQuestion.textContent = currentItem.lang1;
    mcqFeedback.textContent = '';
    mcqAnswered = false;

    // Speak the question on click
    mcqQuestion.onclick = () => {
        speakText(currentItem.lang1, activeTargetStudyLanguage);
    };

    let options = [currentItem.lang2, ...shuffleArray(vocabulary.filter(v => v.lang1 !== currentItem.lang1)).slice(0, 3).map(v => v.lang2)];
    mcqOptions.innerHTML = '';
    shuffleArray(options).forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'btn mcq-option-btn';
        btn.textContent = opt;
        btn.onclick = () => {
            // Speak the option immediately on click
            speakText(opt, activeTargetStudyLanguage);
            checkMcqAnswer(btn, opt === currentItem.lang2, currentItem);
        };
        mcqOptions.appendChild(btn);
    });
}

            function checkMcqAnswer(button, isCorrect, item) {
                if (mcqAnswered) return;
                mcqAnswered = true;
                button.classList.add(isCorrect ? 'correct-answer' : 'incorrect-answer');
                if (!isCorrect) {
                    mcqFeedback.textContent = `Correct: ${item.lang2}`;
                    mcqOptions.querySelectorAll('.mcq-option-btn').forEach(btn => {
                        if (btn.textContent === item.lang2) btn.classList.add('correct-answer');
                    });
                }
                nextMcqBtn.classList.remove('hidden');
            }

            function initTypeTranslationGame() {
                let typeTransGameActiveVocab = shuffleArray(currentVocabularyPart);
                currentTypeTranslationIndex = 0;
                typeTranslationGameContainer.classList.remove('hidden');
                displayNextTypeTranslation(typeTransGameActiveVocab);
            }

            function displayNextTypeTranslation(gameVocab) {
                if (currentTypeTranslationIndex >= gameVocab.length) {
                    typeTranslationPhrase.textContent = "Part Complete!";
                    typeTranslationInput.style.display = 'none';
                    return;
                }
                const item = gameVocab[currentTypeTranslationIndex];
                typeTranslationPhrase.textContent = item.lang2;
                typeTranslationInput.value = '';
                typeTranslationFeedback.textContent = '';
                nextTypeTranslationBtn.classList.add('hidden');
            }

            function checkTypeTranslation() {
                const item = currentVocabularyPart[currentTypeTranslationIndex];
                const isCorrect = typeTranslationInput.value.trim().toLowerCase() === item.lang1.toLowerCase();
                typeTranslationFeedback.textContent = isCorrect ? "Correct!" : `Correct: ${item.lang1}`;
                nextTypeTranslationBtn.classList.remove('hidden');
            }

            function initFillInTheBlanksGame() {
                fillInTheBlanksGameContainer.classList.remove('hidden');
                fillInTheBlanksSentence.textContent = "Fill in the blanks is not yet implemented.";
            }

            function initTalkToMeGame() {
                talkToMeGameContainer.classList.remove('hidden');
                let talkToMeActiveVocab = shuffleArray(currentVocabularyPart);
                currentTalkToMeIndex = 0;
                displayNextTalkToMe(talkToMeActiveVocab);
            }

            function displayNextTalkToMe(gameVocab) {
                if (currentTalkToMeIndex >= gameVocab.length) {
                    talkToMePhraseText.textContent = "Part Complete!";
                    return;
                }
                const item = gameVocab[currentTalkToMeIndex];
                talkToMePhraseText.textContent = item.lang1;
                talkToMeRecognizedText.textContent = "...";
                talkToMeFeedback.textContent = "";
                nextTalkToMeBtn.classList.add('hidden');
            }

            function startListening() {
                if (!recognition || isListening) return;
                recognition.lang = activeTargetStudyLanguage;
                recognition.start();
                isListening = true;
                listenBtnText.textContent = 'Listening...';
            }

            function stopListening() {
                if (!recognition || !isListening) return;
                recognition.stop();
                isListening = false;
                listenBtnText.textContent = 'Start Listening';
            }

            function checkSpeechAnswer(spokenText) {
                const item = currentVocabularyPart[currentTalkToMeIndex];
                const isCorrect = normalizeText(spokenText) === normalizeText(item.lang1);
                talkToMeFeedback.textContent = isCorrect ? "Correct!" : "Not quite, try again.";
                nextTalkToMeBtn.classList.remove('hidden');
            }

            function initFindTheWordsGame() {
                findTheWordsGameContainer.classList.remove('hidden');
                let findWordsSessionPool = shuffleArray(currentVocabularyPart);
                currentFindWordsRound = 0;
                nextFindTheWordsRound(findWordsSessionPool);
            }

            async function nextFindTheWordsRound(pool) {
                if (currentFindWordsRound >= MAX_FIND_WORDS_ROUNDS || pool.length < WORDS_PER_FIND_WORDS_TARGET) {
                    findTheWordsInstructions.textContent = "Game Complete!";
                    findTheWordsGrid.innerHTML = '';
                    return;
                }
                currentFindWordsRound++;
                findWordsTargetWords = pool.splice(0, WORDS_PER_FIND_WORDS_TARGET);
                let distractors = shuffleArray(vocabulary.filter(v => !findWordsTargetWords.includes(v))).slice(0, WORDS_PER_FIND_WORDS_DISPLAY - WORDS_PER_FIND_WORDS_TARGET);
                let findWordsCurrentChoices = shuffleArray([...findWordsTargetWords, ...distractors]);
                findTheWordsGrid.innerHTML = '';
                findWordsCurrentChoices.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'game-card card p-2';
                    card.textContent = item.lang1;
                    card.onclick = () => toggleFindWordSelection(card, item);
                    findTheWordsGrid.appendChild(card);
                });
                for (const word of findWordsTargetWords) {
                    await speakText(word.lang1, activeTargetStudyLanguage);
                }
            }
            
            function toggleFindWordSelection(card, item) {
                card.classList.toggle('selected-find-word');
                const index = findWordsSelectedWords.findIndex(i => i.lang1 === item.lang1);
                if (index > -1) findWordsSelectedWords.splice(index, 1);
                else findWordsSelectedWords.push(item);
                sendFindTheWordsBtn.disabled = findWordsSelectedWords.length === 0;
            }

            function checkFindTheWordsAnswer() {
                const correctCount = findWordsSelectedWords.filter(s => findWordsTargetWords.includes(s)).length;
                findTheWordsFeedback.textContent = `You found ${correctCount} of ${findWordsTargetWords.length}.`;
                nextFindTheWordsRoundBtn.classList.remove('hidden');
            }

            // --- EVENT LISTENERS ---
            authToggleText.addEventListener('click', (e) => { if (e.target.matches('.toggle-auth-link')) { e.preventDefault(); toggleAuthMode(); } });
            authForm.addEventListener('submit', async (e) => { 
                e.preventDefault(); 
                const email = document.getElementById('emailInput').value.trim(); 
                const password = document.getElementById('passwordInput').value.trim(); 
                authError.textContent = ''; 
                try { 
                    if (isSignUp) { 
                        const { error } = await supabaseClient.auth.signUp({ email, password }); 
                        if (error) { 
                            authError.textContent = error.message; 
                        } else { 
                            alert('Sign up successful! Please check your email to confirm your account.'); 
                            toggleAuthMode(); 
                        } 
                    } else { 
                        const { error } = await supabaseClient.auth.signInWithPassword({ email, password }); 
                        if (error) { 
                            authError.textContent = error.message; 
                        } 
                    } 
                } catch (err) { 
                    authError.textContent = 'Unexpected error. Try again.'; 
                    console.error(err); 
                } 
            });
            googleLoginBtn.addEventListener('click', async () => { 
                const { error } = await supabaseClient.auth.signInWithOAuth({ provider: 'google' }); 
                if (error) { authError.textContent = error.message; } 
            });
            logoutBtn.addEventListener('click', async () => { 
                try {
                    await supabaseClient.auth.signOut(); 
                    window.location.reload(); 
                } catch (error) {
                    console.error('Logout error:', error);
                    // Force reload anyway
                    window.location.reload();
                }
            });
            
            addNotesBtn.addEventListener('click', showMainSelection);
            showUploadSectionBtn.addEventListener('click', () => { mainSelectionSection.classList.add('hidden'); uploadSection.classList.remove('hidden'); });
            backToMainSelectionFromUploadBtn.addEventListener('click', showMainSelection);
            showEssentialsSectionBtn.addEventListener('click', () => { mainSelectionSection.classList.add('hidden'); essentialsCategorySelectionSection.classList.remove('hidden'); isEssentialsMode = true; populateEssentialsCategoryButtons(); });
            backToMainSelectionFromEssentialsBtn.addEventListener('click', showMainSelection);
            backToEssentialsCategoriesBtn.addEventListener('click', () => { essentialsCategoryOptionsSection.classList.add('hidden'); essentialsCategorySelectionSection.classList.remove('hidden'); });
            reviewEssentialsCategoryBtn.addEventListener('click', () => { initializeAudio(); essentialsCategoryOptionsSection.classList.add('hidden'); gameArea.classList.remove('hidden'); startGame('matching'); });
            playGamesWithEssentialsBtn.addEventListener('click', () => { initializeAudio(); essentialsCategoryOptionsSection.classList.add('hidden'); showGameSelection(); });
            backToGameSelectionBtn.addEventListener('click', showGameSelection);
            backToSourceSelectionBtn.addEventListener('click', () => { gameSelectionSection.classList.add('hidden'); if (isEssentialsMode) { essentialsCategoryOptionsSection.classList.remove('hidden'); } else { showMainSelection(); } });
            matchingBtn.addEventListener('click', () => { initializeAudio(); showPartSelection('matching'); });
            multipleChoiceBtn.addEventListener('click', () => { initializeAudio(); showPartSelection('multipleChoice'); });
            typeTranslationBtn.addEventListener('click', () => { initializeAudio(); showPartSelection('typeTranslation'); });
            talkToMeBtn.addEventListener('click', () => { initializeAudio(); showPartSelection('talkToMe'); });
            fillInTheBlanksBtn.addEventListener('click', () => { initializeAudio(); showPartSelection('fillInTheBlanks'); });
            findTheWordsBtn.addEventListener('click', () => { initializeAudio(); showPartSelection('findTheWords'); });
            uploadBtn.addEventListener('click', () => handleFileUpload());
            csvFileInput.addEventListener('change', () => handleFileUpload());
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.add('dragover-active'); });
            dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('dragover-active'); });
            dropZone.addEventListener('drop', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('dragover-active'); if (e.dataTransfer.files && e.dataTransfer.files.length > 0) { handleFileUpload(e.dataTransfer.files[0]); } });

            // Game specific event listeners
            if (checkTypeTranslationBtn) checkTypeTranslationBtn.addEventListener('click', checkTypeTranslation);
            if (listenBtn) listenBtn.addEventListener('click', startListening);
            if (sendFindTheWordsBtn) sendFindTheWordsBtn.addEventListener('click', checkFindTheWordsAnswer);
            if (nextMcqBtn) nextMcqBtn.addEventListener('click', () => { 
                mcqAnswered = false; 
                currentMcqIndex++; 
                displayNextMcq(currentVocabularyPart); 
                nextMcqBtn.classList.add('hidden'); 
            });
            if (nextTypeTranslationBtn) nextTypeTranslationBtn.addEventListener('click', () => { 
                typeTranslationAnswered = false; 
                currentTypeTranslationIndex++; 
                displayNextTypeTranslation(currentVocabularyPart); 
                nextTypeTranslationBtn.classList.add('hidden'); 
            });
            if (nextTalkToMeBtn) nextTalkToMeBtn.addEventListener('click', () => { 
                currentTalkToMeIndex++; 
                displayNextTalkToMe(currentVocabularyPart); 
                nextTalkToMeBtn.classList.add('hidden'); 
            });

            // --- INITIALIZATION ---
            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                if (session) {
                    loginSection.classList.add('hidden');
                    appContent.classList.remove('hidden');
                    await fetchNotes();
                    if (vocabulary.length > 0) {
                        showGameSelection();
                    } else {
                        showMainSelection();
                    }
                } else {
                    loginSection.classList.remove('hidden');
                    appContent.classList.add('hidden');
                    vocabulary = [];
                }
            });

            showMainSelection(); 
            setupMistakeTracker(); 
            updateScoreDisplay();
            initSpeechRecognition();
        });

        
    </script>
</body>
</html>
